# dailyfresh
利用python的django框架实现中小型电商项目(B2C)

    
1.需求分析
    1.1 用户模块

        1)注册页
            注册时校验用户名是否已被注册。
            完成用户信息的注册。
            给用户的注册邮箱发送邮件，用户点击邮件中的激活链接完成用户账户的激活。

        2)登录页
            实现用户的登录功能。

        3)用户中心
            用户中心信息页：显示登录用户的信息，包括用户名、电话和地址，同时页面下方显示出用户最近浏览的商品信息。
            用户中心地址页：显示登录用户的默认收件地址，页面下方的表单可以新增用户的收货地址。
            用户中心订单页：显示登录用户的订单信息。

        4)其他
            如果用户已经登录，页面顶部显示登录用户的信息。

    1.2 商品相关

        1)首页
            动态指定首页轮播商品信息。
            动态指定首页活动信息。
            动态获取商品的种类信息并显示。
            动态指定首页显示的每个种类的商品(包括图片商品和文字商品)。
            点击某一个商品时跳转到商品的详情页面。

        2)商品详情页
            显示出某个商品的详情信息。
            页面的左下方显示出该种类商品的2个新品信息。

        3）商品列表页
            显示出某一个种类商品的列表数据，分页显示并支持按照默认、价格、和人气进行排序。
            页面的左下方显示出该种类商品的2个新品信息。

        4）其他
            通过页面搜索框搜索商品信息。

    1.3 购物车相关
            列表页和详情页将商品添加到购物车。
            用户登录后，首页，详情页，列表页显示登录用户购物车中商品的数目。
            购物车页面：对用户购物车中商品的操作。如选择某件商品，增加或减少购物车中商品的数目。

    1.4 订单相关
            提交订单页面：显示用户准备购买的商品信息。
            点击提交订单完成订单的创建。
            用户中心订单页显示用户的订单信息。
            点击支付完成订单的支付。

第一天进度:
    主要工作:数据库搭建
    
    1.明确分类,将数据库抽象到四个应用中.
        1)用户类
            (1.1) 用户信息表(这里我们使用django中以实现的抽象用户类(AbstractUser))
            (1.2) 用户收货地址表(一个用户对应可多个收货地址)
        2)商品类
            (2.1) 商品分类表
            (2.2) 商品的spu表
            (2.3) 商品的sku表
            (2.4) 商品图片表
            (2.5) 首页促销活动表
            (2.6) 首页商品轮播表
            (2.7) 首页商品分类及个别商品展示表
        3)订单类
            (3.1) 订单信息表
            (3.2) 订单商品信息表
        4)购物车
            购物车目前准备不熟于redis中

第二天进度:
    主要工作:用户相关视图

    1.用户注册页面
        用户相关视图的实现主要应用了django中已经封装好的user模块(AbstractUser)
        1)定义注册视图,配置url
        2)如果用户通过get方法访问视图将注册页面返回给用户
        3)如果用户通过post发放请求进行相关逻辑处理
            (3.1)接收用户提交的表单数据
            (3.2)验证信息是否符合规范
            (3.3)判断用户名是否已被注册
            (3.4)通过邮件发送激活链接
                (3.4.1)setting中配置发送邮件相关环境
                (3.4.2)将用户id利用itsdangrous加密放入激活链接中
                (3.4.3)通过send_mail方法发送邮件至用户邮箱

    2.用户激活
        当用户点击邮件内链接时,解密id,讲数据库中的激活标记改为1完成激活,跳转至登录页面

    3.用户登录页面
        应用django封装好的authenticate,login
        1)定义登录视图,配置url
        2)如果用户通过get方式请求讲登录页面返回给用户
            (2.1)判断我们存储的cookie是否在cookie字典里
            (2.2)如果在表示用户记住了用户名,将cookie的值传入input标签的value值
            (2.3)将checked传入input标签表示,勾选了记住用户名/
        3)如果用户通过post发送请求进行相关逻辑处理
            (3.1)接收用户提交的表单数据
            (3.2)判断账号密码信息是否符合规范
            (3.3)利用django中内置的authenticate方法校验账号密码是否匹配
                (3.3.1)判断用户是否激活
                (3.3.2)如果激活,添加登录标记,利用login记录登录状态
                (3.3.3)如果用户勾选记住账号,设置cookie
    
    4.退出登录
        利用django内置的logout方法

        1)当用户点击退出登录时,利用logout删除登录标记

第三天进度:
    主要工作:用户中心页面相关视图

    1.用户中心的收货地址页面.
        利用管理器查询默认的收货地址,利用django内置封装好的login_required方法来判断用户是否已经登录
            
        1)用户如果未登录,跳转至登录界面,如果已登录,执行视图
        2)用户通过get请求访问时为获取收货地址页面
            (2.1)通过request的user方法获取当前用户对象
            (2.2)通过自定义的管理器查询当前用户是否有默认地址
            (2.3)将查询结果传递给魔板
            (2.4)在模板进行逻辑判断,如果有数据显示出默认地址
            (2.5)如果没有数据显示空
        3)用户通过post访问时为添加收货地址
            (3.1)获取当前用户对象,获取表单提交的数据
            (3.2)判断用户提交的数据是否完整
            (3.3)判断用户是否已有默认地址
            (3.4)向数据库中添加数据
    
    2.用户中心的个人中心页面
        假设利用了redis来存放最近浏览订单的id(订单页面还未开发)
        
        1)用户如果未登录,跳转至登录界面,如果已登录,执行视图
        2)获取登录的user对象
        3)通过自定义管理器定义的方法获取默认显示的地址对象,传给模板
            (3.1)在模板上进行判断,如果查询到了默认地址则显示,未查询到显示无
        4)通过redis模块里的 StrictRedis 创建对象后可直接操作redis数据库
            (4.1)提前构建好redis,利用redis内的列表来进行存储
            (4.2)将用户的id设为列表的key,将用户浏览的订单id设为值
        5)取出列表里的前五个数据,列表内存放的为用户浏览的商品sku id
        6)获取用户浏览过的所有商品的查询集
        7)通过将查询集与列表进行遍历,将商品sku对象按顺序添加至新的列表
        8)将地址对象和列表返回模板

第四天进度:
    主要工作:网站首页部署,配置FDFS文件存储系统

    1.配置文件存储
        利用FDFS将图片文件存储在远程服务器
        
        1)导入django模块Storage,自定义文件上传类继承自Storage
        2)需要实现固定的4个方法
            (2.1)_open(name,mode='rb')方法,在打开文件时调用,这里我们可以直接pass
            (2.2)_save(name,content)方法,在上传保存文件时调用,返回值会被保存在数据库的字段中
                (2.2.1)创建一个Fdfs_client对象传入我们写好的配置文件路径作为参数
                (2.2.2)通关文件对象content读取文件内容
                (2.2.3)调用Fdfs_client对象的方法upload_by_buffer方法上传文件,方法会返回一个文件id保存在数据库中
                    (2.2.3.1)进行逻辑判断如果上传成功返回文件id
                    (2.2.3.2)否则抛出异常
            (2.3)exists方法,在save方法之前调用,会判断上传的文件是否已存在,这里我们用的Fdfs系统,无需考虑直接返回False
            (2.4)url方法,返回用户可访问到的文件url路径

    2.网站首页部署
        由于购物车内的订单信息我们预计会存入redis中,所以首页显示的购物车内订单数需要读取redis数据库

        1)定义类视图
        2)利用redis数据库的hlen方法获取购物车内订单的数量
        3)读取数据表中已存好的数据对模板进行渲染
            (3.1)由于首页商品展示表中,分为文字展示部分和图片展示部分,并且需要按照相应的顺序进行展示,所以我们动态的向商品分类表中增加两个属性,方便我们在模板渲染时直接调用.

第五天进度:
    主要工作:网站优化,分类商品页面,与单个商品页面的实现

    1.优化首页
        利用缓存和生成静态文件的方式减少数据库的查询次数

        1)利用celery在未登录的用户访问主页时,将主页保存为静态文件,防止DDOS攻击
            (1.1)未避免写入文件时阻塞用户浏览主页,将保存文件任务交由celery的worker来执行.  
            (1.2)在每次数据库修改时重新生成桌面的静态文件,数据库在发生变化时会首先调用admin里的save_model 和delete_model方法.

        2)静态页面用于返回给未登录用户,已登录用户利用缓存来防止DDOS攻击
            (2.1)在用户首次访问首页是利用缓存的API设置缓存内容,在用户再次访问首页时读取缓存数据.
            (2.2)在数据库发生改变时删除缓存内容,以达到重新设置缓存的目的.

    2.商品详情页面
        
        1)通过url捕获参数商品的id
        2)从数据库查询出模板页面所需要的数据
        3)在商品页面被get方式请求时,将商品id存入redis中
    
    3.商品分类显示页面
        
        1)通过url捕获两个参数,分别为,商品分类的id和页码
        2)获取get方式提交的参数,根据参数的不同,返回不同的数据排序方式
        3)利用django内置的paginator方法来实现分页功能
        4)从数据库中查询出模板需要的数据进行渲染

            

